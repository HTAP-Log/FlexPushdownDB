project(normal-ssb VERSION "${PROJECT_VERSION}" LANGUAGES C CXX)

# need to link libraries on mac
if(${APPLE})
    message("MAC OS X")
    LINK_DIRECTORIES(/usr/local/opt/llvm/lib)
    LINK_DIRECTORIES(/usr/local/opt/binutils/lib)
else()
    message("NOT MAC OS X")
endif()

#-----------------------------------------------------------------------------------------------------------------------
# SSB common classes
#-----------------------------------------------------------------------------------------------------------------------

add_library(normal-ssb
        include/normal/ssb/Globals.h
        src/TestUtil.cpp include/normal/ssb/TestUtil.h
        src/SQLite3.cpp include/normal/ssb/SQLite3.h
        src/SqlGenerator.cpp include/normal/ssb/SqlGenerator.h
        src/SSBSchema.cpp include/normal/ssb/SSBSchema.h src/GenerateSqlFile.cpp
        include/normal/ssb/common/Operators.h src/common/Operators.cpp
        src/query1_1/Operators.cpp include/normal/ssb/query1_1/Operators.h
        src/query1_1/SQL.cpp include/normal/ssb/query1_1/SQL.h
        src/query1_1/S3SelectQueries.cpp include/normal/ssb/query1_1/S3SelectQueries.h
        src/query1_1/LocalFileSystemQueries.cpp include/normal/ssb/query1_1/LocalFileSystemQueries.h
        src/query1_1/LocalFileSystemTests.cpp include/normal/ssb/query1_1/LocalFileSystemTests.h
        src/query1_1/S3SelectTests.cpp include/normal/ssb/query1_1/S3SelectTests.h
        src/query1_1/S3SelectTests.cpp include/normal/ssb/query1_1/S3SelectTests.h
        src/query2_1/Operators.cpp  include/normal/ssb/query2_1/Operators.h
        src/query2_1/LocalFileSystemTests.cpp include/normal/ssb/query2_1/LocalFileSystemTests.h
        src/query2_1/LocalFileSystemQueries.cpp include/normal/ssb/query2_1/LocalFileSystemQueries.h
        src/query2_1/SQL.cpp include/normal/ssb/query2_1/SQL.h )

target_include_directories(normal-ssb PUBLIC include)

target_link_libraries(normal-ssb PRIVATE doctest::doctest)
target_link_libraries(normal-ssb PRIVATE LLVM-filesystem)
target_link_libraries(normal-ssb PRIVATE fmt::fmt)
target_link_libraries(normal-ssb PRIVATE normal-plan)
target_link_libraries(normal-ssb PRIVATE sqlite3_static)
target_link_libraries(normal-ssb PRIVATE sqlite3_csv_static)
target_link_libraries(normal-ssb PUBLIC normal-pushdown)
target_link_libraries(normal-ssb PUBLIC spdlog::spdlog)


#-----------------------------------------------------------------------------------------------------------------------
# Benchmark
#-----------------------------------------------------------------------------------------------------------------------

add_executable(normal-ssb-benchmark
        bench/Main.cpp
        bench/ATTIC/SSBBenchmark.cpp
        bench/ATTIC/SSBNanoBenchmark.cpp
        bench/SSBBenchmarkQuery1_1FileSF0_01.cpp
        bench/SSBBenchmarkQuery1_1FileSF1.cpp
        bench/Globals.h)

target_link_libraries(normal-ssb-benchmark doctest::doctest)
target_link_libraries(normal-ssb-benchmark Backward::Backward)
target_link_libraries(normal-ssb-benchmark nanobench::nanobench)
target_link_libraries(normal-ssb-benchmark normal-ssb)
target_link_libraries(normal-ssb-benchmark normal-sql)


#-----------------------------------------------------------------------------------------------------------------------
# Test
#-----------------------------------------------------------------------------------------------------------------------

add_executable(normal-ssb-test
        test/Main.cpp
        test/SSBQuery1_1FileTestSF0_01.cpp
        test/SSBQuery1_1FileTestSF1.cpp
        test/SSBQuery1_1S3PullUpTestSF0_01.cpp
        test/SSBQuery1_1SQLTest.cpp
        test/SSBQuery1_1S3PushDownTestSF0_01.cpp
        test/SSBQuery1_1S3HybridTestSF0_01.cpp
        test/SSBQuery2_1FileTestSF0_01.cpp
        test/SSBTestQuery1_1FileParquetSF0_01.cpp
        test/MiscTest.cpp
        test/Globals.h)

target_link_libraries(normal-ssb-test doctest::doctest)
target_link_libraries(normal-ssb-test Backward::Backward)
target_link_libraries(normal-ssb-test normal-ssb)
target_link_libraries(normal-ssb-test normal-sql)


#-----------------------------------------------------------------------------------------------------------------------
# Tool
#-----------------------------------------------------------------------------------------------------------------------

add_executable(normal-ssb-tool
        tool/Main.cpp)

target_link_libraries(normal-ssb-tool PRIVATE spdlog::spdlog)
target_link_libraries(normal-ssb-tool PRIVATE normal-ssb)
target_link_libraries(normal-ssb-tool PRIVATE normal-tuple)


#-----------------------------------------------------------------------------------------------------------------------
# Data
#-----------------------------------------------------------------------------------------------------------------------

# Generate SSB SF=0.01 data set

add_custom_target(normal-ssb-data-generate
        COMMAND DSS_PATH=${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1 ${SSB_DBGEN_EXECUTABLE} -f -v -s 1
        WORKING_DIRECTORY ${SSB_DBGEN_WORKING_DIRECTORY})
add_dependencies(normal-ssb-data-generate ssb_db_gen)

# dbgen doesn't generate headers so we add them manually
add_custom_target(normal-ssb-data-prepend-headers
        COMMAND sed -i '' '1s/^/LO_ORDERKEY,LO_LINENUMBER,LO_CUSTKEY,LO_PARTKEY,LO_SUPPKEY,LO_ORDERDATE,LO_ORDERPRIORITY,LO_SHIPPRIORITY,LO_QUANTITY,LO_EXTENDEDPRICE,LO_ORDTOTALPRICE,LO_DISCOUNT,LO_REVENUE,LO_SUPPLYCOST,LO_TAX,LO_COMMITDATE,LO_SHIPMODE\\n/' ${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/lineorder.tbl
        COMMAND sed -i '' '1s/^/P_PARTKEY,P_NAME,P_MFGR,P_CATEGORY,P_BRAND1,P_COLOR,P_TYPE,P_SIZE,P_CONTAINER\\n/' ${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/part.tbl
        COMMAND sed -i '' '1s/^/S_SUPPKEY,S_NAME,S_ADDRESS,S_CITY,S_NATION,S_REGION,S_PHONE\\n/' ${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/supplier.tbl
        COMMAND sed -i '' '1s/^/C_CUSTKEY,C_NAME,C_ADDRESS,C_CITY,C_NATION,C_REGION,C_PHONE,C_MKTSEGMENT\\n/' ${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/customer.tbl
        COMMAND sed -i '' '1s/^/D_DATEKEY,D_DATE,D_DAYOFWEEK,D_MONTH,D_YEAR,D_YEARMONTHNUM,D_YEARMONTH,D_DAYNUMINWEEK,D_DAYNUMINMONTH,D_DAYNUMINYEAR,D_MONTHNUMINYEAR,D_WEEKNUMINYEAR,D_SELLINGSEASON,D_LASTDAYINWEEKFL,D_LASTDAYINMONTHFL,D_HOLIDAYFL,D_WEEKDAYFL\\n/' ${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/date.tbl)
add_dependencies(normal-ssb-data-prepend-headers normal-ssb-data-generate)

add_custom_target(normal-ssb-data)
add_dependencies(normal-ssb-data normal-ssb-data-prepend-headers)


# Copy data to runtime directory

configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/customer.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/customer.tbl COPYONLY)
configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/date.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/date.tbl COPYONLY)
configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/lineorder.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/lineorder.tbl COPYONLY)
configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/part.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/part.tbl COPYONLY)
configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/supplier.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/supplier.tbl COPYONLY)

#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/customer.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/customer.tbl COPYONLY)
#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/date.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/date.tbl COPYONLY)
#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/lineorder.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/lineorder.tbl COPYONLY)
#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/part.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/part.tbl COPYONLY)
#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/supplier.tbl ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/supplier.tbl COPYONLY)

configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/parquet/customer.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/parquet/customer.snappy.parquet COPYONLY)
configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/parquet/date.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/parquet/date.snappy.parquet COPYONLY)
configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/parquet/lineorder.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/parquet/lineorder.snappy.parquet COPYONLY)
configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/parquet/part.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/parquet/part.snappy.parquet COPYONLY)
configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf0.01/parquet/supplier.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf0.01/parquet/supplier.snappy.parquet COPYONLY)

#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/parquet/customer.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/parquet/customer.snappy.parquet COPYONLY)
#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/parquet/date.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/parquet/date.snappy.parquet COPYONLY)
#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/parquet/lineorder.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/parquet/lineorder.snappy.parquet COPYONLY)
#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/parquet/part.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/parquet/part.snappy.parquet COPYONLY)
#configure_file(${CMAKE_CURRENT_LIST_DIR}/data/ssb-sf1/parquet/supplier.snappy.parquet ${CMAKE_CURRENT_BINARY_DIR}/data/ssb-sf1/parquet/supplier.snappy.parquet COPYONLY)

#-----------------------------------------------------------------------------------------------------------------------
# Query generator
#-----------------------------------------------------------------------------------------------------------------------

add_library(normal-ssb-query-generate
        src/SqlGenerator.cpp include/normal/ssb/SqlGenerator.h)

target_link_libraries(normal-ssb-query-generate PRIVATE doctest::doctest)
target_link_libraries(normal-ssb-query-generate PRIVATE normal-ssb)

add_executable(normal-ssb-query-generate-file
        src/GenerateSqlFile.cpp)

target_link_libraries(normal-ssb-query-generate-file PRIVATE normal-ssb-query-generate)
target_link_libraries(normal-ssb-query-generate-file PRIVATE normal-ssb)

#-----------------------------------------------------------------------------------------------------------------------
# Experiment
#-----------------------------------------------------------------------------------------------------------------------

add_executable(normal-ssb-experiment
        experiment/ExperimentMain.cpp
        experiment/Tests.cpp
        experiment/ExperimentUtil.cpp   experiment/ExperimentUtil.h
        experiment/HardcodedPlanTestSinglePartition.cpp
        experiment/HardcodedPlanTestMultiPartition.cpp
        experiment/SqliteTest.cpp experiment/BeladyTest.cpp
        experiment/Tests.h)

target_link_libraries(normal-ssb-experiment doctest::doctest)
target_link_libraries(normal-ssb-experiment Backward::Backward)
target_link_libraries(normal-ssb-experiment normal-ssb)
target_link_libraries(normal-ssb-experiment normal-sql)
target_link_libraries(normal-ssb-experiment normal-ssb-query-generate)

# Copy ssb query files to runtime directory

set(SSB_query_file_list
        "original/query1.1.sql" "original/query1.2.sql" "original/query1.3.sql"
        "original/query2.1.sql" "original/query2.2.sql" "original/query2.3.sql"
        "original/query3.1.sql" "original/query3.2.sql" "original/query3.3.sql" "original/query3.4.sql"
        "original/query4.1.sql" "original/query4.2.sql" "original/query4.3.sql"
        "filterlineorder/query1.1.sql" "filterlineorder/query1.2.sql" "filterlineorder/query1.3.sql"
        "filterlineorder/query2.1.sql" "filterlineorder/query2.2.sql" "filterlineorder/query2.3.sql"
        "filterlineorder/query3.1.sql" "filterlineorder/query3.2.sql" "filterlineorder/query3.3.sql" "filterlineorder/query3.4.sql"
        "filterlineorder/query4.1.sql" "filterlineorder/query4.2.sql" "filterlineorder/query4.3.sql")

FOREACH(SSB_query_file ${SSB_query_file_list})
    configure_file(${CMAKE_CURRENT_LIST_DIR}/sql/${SSB_query_file} ${CMAKE_CURRENT_BINARY_DIR}/sql/${SSB_query_file} COPYONLY)
ENDFOREACH()

#-----------------------------------------------------------------------------------------------------------------------
# Metadata
#-----------------------------------------------------------------------------------------------------------------------

configure_file(metadata/ssb-sf1-sortlineorder/csv/sort/lineorder_orderdate ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf1-sortlineorder/csv/sort/lineorder_orderdate COPYONLY)
configure_file(metadata/ssb-sf1-sortlineorder/csv/column_length ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf1-sortlineorder/csv/column_length COPYONLY)
configure_file(metadata/ssb-sf1-sortlineorder/csv/schemas ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf1-sortlineorder/csv/schemas COPYONLY)
configure_file(metadata/ssb-sf1-sortlineorder/csv/partitionNums ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf1-sortlineorder/csv/partitionNums COPYONLY)
configure_file(metadata/ssb-sf1-sortlineorder/csv/segment_info ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf1-sortlineorder/csv/segment_info COPYONLY)

configure_file(metadata/ssb-sf10-sortlineorder/csv/sort/lineorder_orderdate ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf10-sortlineorder/csv/sort/lineorder_orderdate COPYONLY)
configure_file(metadata/ssb-sf10-sortlineorder/csv/column_length ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf10-sortlineorder/csv/column_length COPYONLY)
configure_file(metadata/ssb-sf10-sortlineorder/csv/schemas ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf10-sortlineorder/csv/schemas COPYONLY)
configure_file(metadata/ssb-sf10-sortlineorder/csv/partitionNums ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf10-sortlineorder/csv/partitionNums COPYONLY)
configure_file(metadata/ssb-sf10-sortlineorder/csv/segment_info ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf10-sortlineorder/csv/segment_info COPYONLY)

configure_file(metadata/ssb-sf100-sortlineorder/csv/sort/lineorder_orderdate ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv/sort/lineorder_orderdate COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/csv/column_length ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv/column_length COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/csv/schemas ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv/schemas COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/csv/partitionNums ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv/partitionNums COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/csv/segment_info ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv/segment_info COPYONLY)

configure_file(metadata/ssb-sf100-sortlineorder/csv_2GB_lineorder/sort/lineorder_orderdate ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv_2GB_lineorder/sort/lineorder_orderdate COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/csv_2GB_lineorder/column_length ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv_2GB_lineorder/column_length COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/csv_2GB_lineorder/schemas ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv_2GB_lineorder/schemas COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/csv_2GB_lineorder/partitionNums ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/csv_2GB_lineorder/partitionNums COPYONLY)

configure_file(metadata/ssb-sf100-sortlineorder/parquet/sort/lineorder_orderdate ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/parquet/sort/lineorder_orderdate COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/parquet/column_length ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/parquet/column_length COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/parquet/schemas ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/parquet/schemas COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/parquet/partitionNums ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/parquet/partitionNums COPYONLY)

configure_file(metadata/ssb-sf100-sortlineorder/snappy_parquet/sort/lineorder_orderdate ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/snappy_parquet/sort/lineorder_orderdate COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/snappy_parquet/column_length ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/snappy_parquet/column_length COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/snappy_parquet/schemas ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/snappy_parquet/schemas COPYONLY)
configure_file(metadata/ssb-sf100-sortlineorder/snappy_parquet/partitionNums ${CMAKE_CURRENT_BINARY_DIR}/metadata/ssb-sf100-sortlineorder/snappy_parquet/partitionNums COPYONLY)

#-----------------------------------------------------------------------------------------------------------------------
# Diagnostics
#-----------------------------------------------------------------------------------------------------------------------

#showTargetProps(normal-ssb-test)
#showTargetProps(normal-ssb-benchmark)

#-----------------------------------------------------------------------------------------------------------------------
# change lib position for mac (not sure why mac cannot find the correct location of graphviz's lib)
#-----------------------------------------------------------------------------------------------------------------------

set(executables normal-ssb-experiment normal-ssb-query-generate-file)
if(${APPLE})
    FOREACH(executable ${executables})
        add_custom_command(TARGET ${executable} POST_BUILD COMMAND
                ${CMAKE_INSTALL_NAME_TOOL} -change libgvplugin_neato_layout.6.dylib /usr/local/opt/graphviz/lib/graphviz/libgvplugin_neato_layout.6.dylib ${executable})
        add_custom_command(TARGET ${executable} POST_BUILD COMMAND
                ${CMAKE_INSTALL_NAME_TOOL} -change libgvplugin_core.6.dylib /usr/local/opt/graphviz/lib/graphviz/libgvplugin_core.6.dylib ${executable})
    ENDFOREACH()
endif()